<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>R√©servation - Sognudimare</title>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Open+Sans:wght@300;400;600&display=swap" rel="stylesheet">
    <script type="text/javascript" src="https://web.squarecdn.com/v1/square.js"></script>
    <style>
        :root {
            --primary: #0e1c40;
            --primary-light: #1a2d5a;
            --secondary: #ebd0a9;
            --accent: #7ad2d4;
            --white: #ffffff;
            --gray: #f5f5f5;
            --text: #333333;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', sans-serif;
            background: var(--gray);
            color: var(--text);
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: var(--primary);
            color: var(--white);
            padding: 30px 0;
            text-align: center;
        }

        .header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--secondary);
            font-size: 1.1em;
        }

        /* Steps indicator */
        .steps {
            display: flex;
            justify-content: center;
            margin: 30px 0;
            gap: 20px;
            flex-wrap: wrap;
        }

        .step {
            display: flex;
            align-items: center;
            gap: 10px;
            opacity: 0.5;
        }

        .step.active {
            opacity: 1;
        }

        .step.completed {
            opacity: 1;
        }

        .step-number {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: var(--white);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step.completed .step-number {
            background: var(--success);
        }

        .step.active .step-number {
            background: var(--accent);
            color: var(--primary);
        }

        /* Main content */
        .main-content {
            background: var(--white);
            border-radius: 15px;
            padding: 30px;
            margin: 20px 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .section-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.8em;
            color: var(--primary);
            margin-bottom: 20px;
            text-align: center;
        }

        /* Cruise Cards */
        .cruises-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .cruise-card {
            border: 2px solid var(--gray);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .cruise-card:hover {
            border-color: var(--accent);
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
        }

        .cruise-card.selected {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(122, 210, 212, 0.3);
        }

        .cruise-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
        }

        .cruise-info {
            padding: 20px;
        }

        .cruise-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .cruise-subtitle {
            color: var(--accent);
            font-style: italic;
            margin-bottom: 10px;
        }

        .cruise-details {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 15px;
        }

        .cruise-duration {
            color: #666;
            font-size: 0.9em;
        }

        .cruise-price {
            font-weight: bold;
            color: var(--primary);
            font-size: 1.2em;
        }

        /* Booking Options */
        .booking-section {
            display: none;
            margin-top: 30px;
        }

        .booking-section.active {
            display: block;
        }

        /* Booking Type */
        .booking-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .booking-type-card {
            border: 2px solid var(--gray);
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .booking-type-card:hover {
            border-color: var(--accent);
        }

        .booking-type-card.selected {
            border-color: var(--accent);
            background: rgba(122, 210, 212, 0.1);
        }

        .booking-type-icon {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .booking-type-title {
            font-weight: bold;
            font-size: 1.2em;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .booking-type-price {
            color: var(--accent);
            font-weight: bold;
            font-size: 1.1em;
        }

        /* Date Selection */
        .dates-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .date-card {
            border: 2px solid var(--gray);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .date-card:hover:not(.disabled) {
            border-color: var(--accent);
        }

        .date-card.selected {
            border-color: var(--accent);
            background: rgba(122, 210, 212, 0.1);
        }

        .date-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .date-range {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .date-price {
            color: var(--accent);
            font-weight: bold;
        }

        .date-status {
            font-size: 0.85em;
            margin-top: 5px;
        }

        .status-available { color: var(--success); }
        .status-limited { color: var(--warning); }
        .status-full { color: var(--error); }

        /* Passengers */
        .passengers-section {
            margin-bottom: 30px;
        }

        .passengers-row {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 20px;
            margin-bottom: 20px;
        }

        .passenger-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--primary);
            background: var(--white);
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .passenger-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        .passenger-count {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary);
            min-width: 60px;
            text-align: center;
        }

        /* Club Cards */
        .club-section {
            background: var(--gray);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .club-title {
            font-family: 'Playfair Display', serif;
            font-size: 1.3em;
            color: var(--primary);
            margin-bottom: 15px;
            text-align: center;
        }

        .club-cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .club-card {
            background: var(--white);
            border: 2px solid transparent;
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .club-card:hover {
            border-color: var(--secondary);
        }

        .club-card.selected {
            border-color: var(--secondary);
            background: rgba(235, 208, 169, 0.1);
        }

        .club-card-name {
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 5px;
        }

        .club-card-discount {
            color: var(--success);
            font-weight: 600;
        }

        /* Price Summary */
        .price-summary {
            background: var(--primary);
            color: var(--white);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .price-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .price-row.total {
            border-top: 1px solid rgba(255,255,255,0.3);
            padding-top: 15px;
            margin-top: 15px;
            font-size: 1.3em;
            font-weight: bold;
        }

        .discount-row {
            color: var(--success);
        }

        /* Customer Form */
        .customer-form {
            display: none;
            margin-top: 30px;
        }

        .customer-form.active {
            display: block;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--primary);
        }

        .form-group input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--gray);
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* Payment Section */
        .payment-section {
            display: none;
            margin-top: 30px;
        }

        .payment-section.active {
            display: block;
        }

        #card-container {
            min-height: 100px;
            margin-bottom: 20px;
        }

        /* Buttons */
        .btn {
            display: inline-block;
            padding: 15px 40px;
            border-radius: 30px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-transform: uppercase;
        }

        .btn-primary {
            background: var(--accent);
            color: var(--primary);
        }

        .btn-primary:hover {
            background: var(--secondary);
        }

        .btn-secondary {
            background: var(--primary);
            color: var(--white);
        }

        .btn-secondary:hover {
            background: var(--primary-light);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-container {
            text-align: center;
            margin-top: 30px;
        }

        /* Success Message */
        .success-message {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .success-message.active {
            display: block;
        }

        .success-icon {
            font-size: 5em;
            color: var(--success);
            margin-bottom: 20px;
        }

        .success-title {
            font-family: 'Playfair Display', serif;
            font-size: 2em;
            color: var(--primary);
            margin-bottom: 15px;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 50px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--gray);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.8em;
            }

            .steps {
                flex-direction: column;
                align-items: center;
            }

            .main-content {
                padding: 20px;
            }

            .cruises-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="header">
        <div class="container">
            <h1>Sognudimare</h1>
            <p>R√©servez votre croisi√®re en catamaran</p>
        </div>
    </div>

    <!-- Steps -->
    <div class="container">
        <div class="steps">
            <div class="step active" data-step="1">
                <div class="step-number">1</div>
                <span>Croisi√®re</span>
            </div>
            <div class="step" data-step="2">
                <div class="step-number">2</div>
                <span>Options</span>
            </div>
            <div class="step" data-step="3">
                <div class="step-number">3</div>
                <span>Paiement</span>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <div class="main-content">
            <!-- Loading -->
            <div class="loading" id="loading">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>

            <!-- Step 1: Choose Cruise -->
            <div class="booking-section active" id="step1">
                <h2 class="section-title">Choisissez votre croisi√®re</h2>
                <div class="cruises-grid" id="cruises-grid">
                    <!-- Cruises will be loaded here -->
                </div>
                <div class="btn-container">
                    <button class="btn btn-primary" id="btn-step1" disabled onclick="goToStep(2)">
                        Continuer
                    </button>
                </div>
            </div>

            <!-- Step 2: Options -->
            <div class="booking-section" id="step2">
                <h2 class="section-title">Configurez votre r√©servation</h2>
                
                <!-- Booking Type -->
                <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary);">Type de r√©servation</h3>
                <div class="booking-types" id="booking-types">
                    <div class="booking-type-card" data-type="cabin" onclick="selectBookingType('cabin')">
                        <div class="booking-type-icon">üõèÔ∏è</div>
                        <div class="booking-type-title">Cabine Partag√©e</div>
                        <div class="booking-type-desc">Partagez le catamaran avec d'autres voyageurs</div>
                        <div class="booking-type-price" id="cabin-price">√Ä partir de 1 900‚Ç¨/pers</div>
                    </div>
                    <div class="booking-type-card" data-type="private" onclick="selectBookingType('private')">
                        <div class="booking-type-icon">‚õµ</div>
                        <div class="booking-type-title">Privatisation Compl√®te</div>
                        <div class="booking-type-desc">Le catamaran rien que pour vous</div>
                        <div class="booking-type-price" id="private-price">√Ä partir de 8 900‚Ç¨</div>
                    </div>
                </div>

                <!-- Date Selection -->
                <div id="dates-section" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary);">Choisissez vos dates</h3>
                    <div class="dates-grid" id="dates-grid">
                        <!-- Dates will be loaded here -->
                    </div>
                </div>

                <!-- Passengers -->
                <div id="passengers-section" style="display: none;">
                    <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary);">Nombre de passagers</h3>
                    <div class="passengers-row">
                        <button class="passenger-btn" onclick="changePassengers(-1)">-</button>
                        <div class="passenger-count" id="passenger-count">2</div>
                        <button class="passenger-btn" onclick="changePassengers(1)">+</button>
                    </div>
                    <p style="text-align: center; color: #666;">Maximum 8 passagers</p>
                </div>

                <!-- Club Cards -->
                <div id="club-section" style="display: none;" class="club-section">
                    <h3 class="club-title">üé´ Avez-vous une Carte Club ?</h3>
                    <div class="club-cards-grid">
                        <div class="club-card selected" data-card="none" onclick="selectClubCard('none')">
                            <div class="club-card-name">Pas de carte</div>
                            <div class="club-card-discount">Prix standard</div>
                        </div>
                        <div class="club-card" data-card="decouverte" onclick="selectClubCard('decouverte')">
                            <div class="club-card-name">Carte D√©couverte</div>
                            <div class="club-card-discount">-5% par passager</div>
                        </div>
                        <div class="club-card" data-card="passion" onclick="selectClubCard('passion')">
                            <div class="club-card-name">Carte Passion</div>
                            <div class="club-card-discount">-10% par passager</div>
                        </div>
                        <div class="club-card" data-card="prestige" onclick="selectClubCard('prestige')">
                            <div class="club-card-name">Carte Prestige</div>
                            <div class="club-card-discount">-15% par passager</div>
                        </div>
                    </div>
                    <div class="passengers-row" id="club-passengers-row" style="display: none; margin-top: 20px;">
                        <span>Passagers avec carte :</span>
                        <button class="passenger-btn" style="width: 35px; height: 35px; font-size: 1em;" onclick="changeClubPassengers(-1)">-</button>
                        <div class="passenger-count" id="club-passenger-count" style="font-size: 1.3em; min-width: 40px;">1</div>
                        <button class="passenger-btn" style="width: 35px; height: 35px; font-size: 1em;" onclick="changeClubPassengers(1)">+</button>
                    </div>
                </div>

                <!-- Price Summary -->
                <div id="price-summary" style="display: none;" class="price-summary">
                    <h3 style="text-align: center; margin-bottom: 15px;">R√©capitulatif</h3>
                    <div class="price-row">
                        <span id="summary-cruise">Croisi√®re</span>
                        <span id="summary-cruise-price">0 ‚Ç¨</span>
                    </div>
                    <div class="price-row">
                        <span id="summary-passengers">2 passagers</span>
                        <span id="summary-base-price">0 ‚Ç¨</span>
                    </div>
                    <div class="price-row discount-row" id="discount-row" style="display: none;">
                        <span id="summary-discount-label">R√©duction Club</span>
                        <span id="summary-discount">-0 ‚Ç¨</span>
                    </div>
                    <div class="price-row total">
                        <span>TOTAL</span>
                        <span id="summary-total">0 ‚Ç¨</span>
                    </div>
                </div>

                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="goToStep(1)" style="margin-right: 10px;">
                        Retour
                    </button>
                    <button class="btn btn-primary" id="btn-step2" disabled onclick="goToStep(3)">
                        Proc√©der au paiement
                    </button>
                </div>
            </div>

            <!-- Step 3: Payment -->
            <div class="booking-section" id="step3">
                <h2 class="section-title">Finalisez votre r√©servation</h2>
                
                <!-- Customer Form -->
                <div class="customer-form active">
                    <div class="form-group">
                        <label>Nom complet</label>
                        <input type="text" id="customer-name" placeholder="Jean Dupont" required>
                    </div>
                    <div class="form-group">
                        <label>Adresse email</label>
                        <input type="email" id="customer-email" placeholder="jean@exemple.com" required>
                    </div>
                    <div class="form-group">
                        <label>T√©l√©phone</label>
                        <input type="tel" id="customer-phone" placeholder="+33 6 12 34 56 78">
                    </div>
                </div>

                <!-- Payment -->
                <div class="payment-section active">
                    <h3 style="text-align: center; margin-bottom: 15px; color: var(--primary);">Paiement s√©curis√©</h3>
                    <div id="card-container"></div>
                    <p style="text-align: center; color: #666; font-size: 0.9em;">
                        üîí Paiement s√©curis√© par Square
                    </p>
                </div>

                <!-- Final Price -->
                <div class="price-summary" style="margin-top: 20px;">
                    <div class="price-row total">
                        <span>TOTAL √Ä PAYER</span>
                        <span id="final-total">0 ‚Ç¨</span>
                    </div>
                </div>

                <div class="btn-container">
                    <button class="btn btn-secondary" onclick="goToStep(2)" style="margin-right: 10px;">
                        Retour
                    </button>
                    <button class="btn btn-primary" id="btn-pay" onclick="processPayment()">
                        Payer maintenant
                    </button>
                </div>
            </div>

            <!-- Success Message -->
            <div class="success-message" id="success-message">
                <div class="success-icon">‚úì</div>
                <h2 class="success-title">R√©servation confirm√©e !</h2>
                <p style="margin-bottom: 20px;">Merci pour votre r√©servation. Vous allez recevoir un email de confirmation.</p>
                <p style="color: var(--accent); font-weight: bold;" id="success-details"></p>
            </div>
        </div>
    </div>

    <script>
        // API URL - Change this to your deployed backend URL
        const API_URL = 'https://your-backend-url.railway.app/api';
        
        // State
        let cruises = [];
        let selectedCruise = null;
        let bookingType = null;
        let selectedDate = null;
        let passengers = 2;
        let clubCard = 'none';
        let clubPassengers = 1;
        let card = null;
        let squareAppId = '';
        let squareLocationId = '';

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            await loadCruises();
            await initSquare();
        });

        // Load cruises from API
        async function loadCruises() {
            showLoading(true);
            try {
                const response = await fetch(`${API_URL}/cruises`);
                cruises = await response.json();
                renderCruises();
            } catch (error) {
                console.error('Error loading cruises:', error);
                alert('Erreur lors du chargement des croisi√®res. Veuillez r√©essayer.');
            }
            showLoading(false);
        }

        // Initialize Square
        async function initSquare() {
            try {
                const response = await fetch(`${API_URL}/payments/config`);
                const config = await response.json();
                squareAppId = config.application_id;
                squareLocationId = config.location_id;
                
                const payments = Square.payments(squareAppId, squareLocationId);
                card = await payments.card();
                await card.attach('#card-container');
            } catch (error) {
                console.error('Error initializing Square:', error);
            }
        }

        // Render cruises
        function renderCruises() {
            const grid = document.getElementById('cruises-grid');
            grid.innerHTML = cruises.map(cruise => `
                <div class="cruise-card" data-id="${cruise.id}" onclick="selectCruise('${cruise.id}')">
                    <img src="${cruise.image_url}" alt="${cruise.name_fr}" class="cruise-image">
                    <div class="cruise-info">
                        <div class="cruise-name">${cruise.name_fr}</div>
                        <div class="cruise-subtitle">${cruise.subtitle_fr}</div>
                        <div class="cruise-details">
                            <span class="cruise-duration">${cruise.duration}</span>
                            <span class="cruise-price">√Ä partir de ${cruise.pricing.cabin_price}‚Ç¨</span>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Select cruise
        function selectCruise(cruiseId) {
            selectedCruise = cruises.find(c => c.id === cruiseId);
            
            // Update UI
            document.querySelectorAll('.cruise-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.cruise-card[data-id="${cruiseId}"]`).classList.add('selected');
            
            // Enable continue button
            document.getElementById('btn-step1').disabled = false;
            
            // Update prices in step 2
            if (selectedCruise) {
                document.getElementById('cabin-price').textContent = `√Ä partir de ${selectedCruise.pricing.cabin_price}‚Ç¨/pers`;
                document.getElementById('private-price').textContent = `√Ä partir de ${selectedCruise.pricing.private_price}‚Ç¨`;
            }
        }

        // Select booking type
        function selectBookingType(type) {
            bookingType = type;
            
            // Update UI
            document.querySelectorAll('.booking-type-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.booking-type-card[data-type="${type}"]`).classList.add('selected');
            
            // Show dates
            renderDates();
            document.getElementById('dates-section').style.display = 'block';
        }

        // Render dates
        function renderDates() {
            if (!selectedCruise) return;
            
            const grid = document.getElementById('dates-grid');
            grid.innerHTML = selectedCruise.availabilities.map((avail, index) => {
                const isDisabled = avail.status === 'full';
                const statusClass = avail.status === 'available' ? 'status-available' : 
                                   avail.status === 'limited' ? 'status-limited' : 'status-full';
                const statusText = avail.status === 'available' ? 'Disponible' :
                                  avail.status === 'limited' ? `Reste ${avail.remaining_places} places` : 'COMPLET';
                
                return `
                    <div class="date-card ${isDisabled ? 'disabled' : ''}" 
                         data-index="${index}" 
                         onclick="${isDisabled ? '' : `selectDate(${index})`}">
                        <div class="date-range">${avail.date_range}</div>
                        <div class="date-price">${avail.price}‚Ç¨ / pers</div>
                        <div class="date-status ${statusClass}">${statusText}</div>
                    </div>
                `;
            }).join('');
        }

        // Select date
        function selectDate(index) {
            selectedDate = selectedCruise.availabilities[index];
            
            // Update UI
            document.querySelectorAll('.date-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.date-card[data-index="${index}"]`).classList.add('selected');
            
            // Show passengers and club sections
            document.getElementById('passengers-section').style.display = 'block';
            document.getElementById('club-section').style.display = 'block';
            document.getElementById('price-summary').style.display = 'block';
            
            updatePriceSummary();
        }

        // Change passengers
        function changePassengers(delta) {
            const newCount = passengers + delta;
            if (newCount >= 1 && newCount <= 8) {
                passengers = newCount;
                document.getElementById('passenger-count').textContent = passengers;
                
                // Reset club passengers if needed
                if (clubPassengers > passengers) {
                    clubPassengers = passengers;
                    document.getElementById('club-passenger-count').textContent = clubPassengers;
                }
                
                updatePriceSummary();
            }
        }

        // Select club card
        function selectClubCard(cardType) {
            clubCard = cardType;
            
            // Update UI
            document.querySelectorAll('.club-card').forEach(card => {
                card.classList.remove('selected');
            });
            document.querySelector(`.club-card[data-card="${cardType}"]`).classList.add('selected');
            
            // Show/hide club passengers row
            if (cardType !== 'none') {
                document.getElementById('club-passengers-row').style.display = 'flex';
            } else {
                document.getElementById('club-passengers-row').style.display = 'none';
                clubPassengers = 0;
            }
            
            updatePriceSummary();
        }

        // Change club passengers
        function changeClubPassengers(delta) {
            const newCount = clubPassengers + delta;
            if (newCount >= 1 && newCount <= passengers) {
                clubPassengers = newCount;
                document.getElementById('club-passenger-count').textContent = clubPassengers;
                updatePriceSummary();
            }
        }

        // Get discount percentage
        function getDiscountPercent() {
            switch (clubCard) {
                case 'decouverte': return 0.05;
                case 'passion': return 0.10;
                case 'prestige': return 0.15;
                default: return 0;
            }
        }

        // Update price summary
        function updatePriceSummary() {
            if (!selectedCruise || !selectedDate) return;
            
            const pricePerPerson = selectedDate.price;
            let basePrice, discount, total;
            
            if (bookingType === 'private') {
                basePrice = selectedCruise.pricing.private_price;
                discount = basePrice * getDiscountPercent();
                total = basePrice - discount;
                
                document.getElementById('summary-passengers').textContent = 'Privatisation compl√®te';
                document.getElementById('summary-base-price').textContent = `${basePrice} ‚Ç¨`;
            } else {
                basePrice = pricePerPerson * passengers;
                
                // Calculate discount only for passengers with club card
                const discountPercent = getDiscountPercent();
                const discountPerPerson = pricePerPerson * discountPercent;
                discount = discountPerPerson * clubPassengers;
                total = basePrice - discount;
                
                document.getElementById('summary-passengers').textContent = `${passengers} passager${passengers > 1 ? 's' : ''} x ${pricePerPerson}‚Ç¨`;
                document.getElementById('summary-base-price').textContent = `${basePrice} ‚Ç¨`;
            }
            
            document.getElementById('summary-cruise').textContent = selectedCruise.name_fr;
            document.getElementById('summary-cruise-price').textContent = selectedDate.date_range;
            
            if (discount > 0) {
                document.getElementById('discount-row').style.display = 'flex';
                const cardName = clubCard === 'decouverte' ? 'D√©couverte' : 
                               clubCard === 'passion' ? 'Passion' : 'Prestige';
                document.getElementById('summary-discount-label').textContent = `R√©duction Carte ${cardName} (${clubPassengers} pers.)`;
                document.getElementById('summary-discount').textContent = `-${discount.toFixed(0)} ‚Ç¨`;
            } else {
                document.getElementById('discount-row').style.display = 'none';
            }
            
            document.getElementById('summary-total').textContent = `${total.toFixed(0)} ‚Ç¨`;
            document.getElementById('final-total').textContent = `${total.toFixed(0)} ‚Ç¨`;
            
            // Enable step 2 button
            document.getElementById('btn-step2').disabled = false;
        }

        // Go to step
        function goToStep(step) {
            // Hide all steps
            document.querySelectorAll('.booking-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Show target step
            document.getElementById(`step${step}`).classList.add('active');
            
            // Update step indicators
            document.querySelectorAll('.step').forEach(s => {
                const stepNum = parseInt(s.dataset.step);
                s.classList.remove('active', 'completed');
                if (stepNum < step) s.classList.add('completed');
                if (stepNum === step) s.classList.add('active');
            });
            
            // Scroll to top
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // Show loading
        function showLoading(show) {
            document.getElementById('loading').classList.toggle('active', show);
            document.getElementById('step1').style.display = show ? 'none' : 'block';
        }

        // Process payment
        async function processPayment() {
            const name = document.getElementById('customer-name').value;
            const email = document.getElementById('customer-email').value;
            
            if (!name || !email) {
                alert('Veuillez remplir tous les champs obligatoires.');
                return;
            }
            
            const btn = document.getElementById('btn-pay');
            btn.disabled = true;
            btn.textContent = 'Traitement en cours...';
            
            try {
                // Get card token from Square
                const result = await card.tokenize();
                
                if (result.status !== 'OK') {
                    throw new Error('Erreur de paiement: ' + result.errors[0].message);
                }
                
                // Calculate total
                const pricePerPerson = selectedDate.price;
                let total;
                if (bookingType === 'private') {
                    total = selectedCruise.pricing.private_price * (1 - getDiscountPercent());
                } else {
                    const basePrice = pricePerPerson * passengers;
                    const discount = pricePerPerson * getDiscountPercent() * clubPassengers;
                    total = basePrice - discount;
                }
                
                // Send payment to backend
                const response = await fetch(`${API_URL}/payments/create`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        source_id: result.token,
                        amount: Math.round(total * 100), // Convert to cents
                        currency: 'EUR',
                        cruise_id: selectedCruise.id,
                        cruise_name: selectedCruise.name_fr,
                        customer_email: email,
                        customer_name: name,
                        passengers: passengers,
                        selected_date: selectedDate.date_range,
                        booking_type: bookingType
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showSuccess();
                } else {
                    throw new Error(data.detail || 'Erreur de paiement');
                }
            } catch (error) {
                console.error('Payment error:', error);
                alert('Erreur: ' + error.message);
                btn.disabled = false;
                btn.textContent = 'Payer maintenant';
            }
        }

        // Show success
        function showSuccess() {
            document.querySelectorAll('.booking-section').forEach(s => s.classList.remove('active'));
            document.getElementById('success-message').classList.add('active');
            document.getElementById('success-details').textContent = 
                `${selectedCruise.name_fr} - ${selectedDate.date_range}`;
            
            // Update all steps to completed
            document.querySelectorAll('.step').forEach(s => s.classList.add('completed'));
        }
    </script>
</body>
</html>
